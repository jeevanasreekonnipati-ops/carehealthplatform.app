<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy - Smart Health</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .med-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            padding: 20px 0;
        }

        .med-card {
            background: var(--bg-dark);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .med-card:hover {
            transform: translateY(-10px);
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(14, 165, 233, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .med-img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.3));
            transition: transform 0.4s ease;
        }

        .med-card:hover .med-img {
            transform: scale(1.05);
        }

        .price {
            font-size: 1.4em;
            color: var(--primary);
            font-weight: 800;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <%- include('partials/header', { user: user }) %>

        <div class="container" style="padding: 60px 5%;">
            <div class="section-header">
                <h2>ðŸ’Š Online Pharmacy</h2>
                <p>Authentic medicines delivered to your doorstep.</p>
            </div>

            <div class="filter-row"
                style="margin-bottom: 40px; display: flex; gap: 15px; flex-wrap: wrap; background: var(--bg-dark); padding: 25px; border-radius: 20px; border: var(--glass-border);">
                <input type="text" id="search" placeholder="Search medicines..." style="flex: 2;"
                    value="<%= typeof query !== 'undefined' ? query : '' %>">

                <select id="category" style="flex: 1; min-width: 180px;">
                    <option value="">All Categories</option>
                    <option value="Pain Relief">Pain Relief</option>
                    <option value="Antibiotics">Antibiotics</option>
                    <option value="Supplements">Supplements</option>
                    <option value="Cold & Flu">Cold & Flu</option>
                    <option value="Heart Health">Heart Health</option>
                    <option value="Diabetes">Diabetes</option>
                    <option value="Allergies">Allergies</option>
                </select>

                <button class="btn" style="min-width: 120px;" onclick="searchMeds()">Search</button>
                <button class="btn accent" onclick="window.location.href='/api/orders/cart'">View Cart ðŸ›’</button>
            </div>

            <div class="med-grid">
                <% medicines.forEach(med=> { %>
                    <div class="med-card">
                        <img src="<%= med.image %>" alt="<%= med.name %>" class="med-img">
                        <div>
                            <h3 style="color: var(--text-bright); font-weight: 700; margin-bottom: 8px;">
                                <%= med.name %>
                            </h3>
                            <p style="color: var(--text-dim); font-size: 0.9em; line-height: 1.5; margin-bottom: 15px;">
                                <%= med.description %>
                            </p>
                            <div class="price">$<%= med.price.toFixed(2) %>
                            </div>
                            <% if (med.requiresPrescription) { %>
                                <span
                                    style="background: rgba(244, 63, 94, 0.1); color: var(--danger); padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Rx
                                    Required</span>
                                <% } %>
                        </div>
                        <button class="btn add-to-cart" style="margin-top: 25px; width: 100%;" data-id="<%= med.id %>"
                            data-name="<%= med.name %>" data-price="<%= med.price %>">Add to Cart</button>
                    </div>
                    <% }) %>
            </div>
        </div>

        <script>
            // Pre-select category if present
            const urlParams = new URLSearchParams(window.location.search);
            const currentCat = urlParams.get('category');
            if (currentCat) document.getElementById('category').value = currentCat;

            // Add event listeners to all "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const name = button.getAttribute('data-name');
                    const price = parseFloat(button.getAttribute('data-price'));
                    addToCart(id, name, price);
                });
            });

            function searchMeds() {
                const query = document.getElementById('search').value;
                const category = document.getElementById('category').value;

                let url = '?';
                if (query) url += `query=${encodeURIComponent(query)}&`;
                if (category) url += `category=${encodeURIComponent(category)}`;
                window.location.href = url;
            }

            function addToCart(id, name, price) {
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existing = cart.find(item => item.id == id);

                if (existing) {
                    existing.quantity += 1;
                    alert(`âœ… Updated!\n\n${name} quantity increased to ${existing.quantity}`);
                } else {
                    cart.push({ id, name, price, quantity: 1 });
                    alert(`âœ… Added to Cart!\n\n${name} has been added to your cart.`);
                }

                localStorage.setItem('cart', JSON.stringify(cart));
            }
        </script>
</body>

</html>